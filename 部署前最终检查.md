# 🚀 魔搭平台部署 - 最终检查清单

## ✅ 自动检查

运行自动检查脚本:
```bash
python check_deploy_readiness.py
```

应该看到: `✓ 所有检查通过! 项目已准备好部署到魔搭平台。`

## 📋 手动检查清单

### 1. 文件完整性检查

- [ ] `Dockerfile` 存在且配置正确
- [ ] `start.sh` 存在且可执行
- [ ] `requirements-lite.txt` 存在
- [ ] `ms_deploy.json` 存在且JSON格式正确
- [ ] `golden_path_integration.py` 存在
- [ ] `werewolf/__init__.py` 存在
- [ ] `werewolf/app.py` 存在

### 2. 安全检查

- [ ] `.env` 文件不会被提交到Git (已在.gitignore中)
- [ ] `ms_deploy.json` 中没有真实的API密钥
- [ ] `.env.example` 已创建作为模板
- [ ] 所有敏感信息都使用环境变量

### 3. 配置检查

- [ ] `Dockerfile` 使用 `requirements-lite.txt`
- [ ] `Dockerfile` 暴露端口 7860
- [ ] `start.sh` 检查必需的环境变量
- [ ] `ms_deploy.json` 中的环境变量使用占位符

### 4. 依赖检查

运行以下命令检查依赖:
```bash
pip install -r requirements-lite.txt --dry-run
```

应该没有冲突或错误。

### 5. 模块导入检查

运行以下命令测试模块导入:
```bash
python -c "import werewolf; print('✓ werewolf模块导入成功')"
python -c "import golden_path_integration; print('✓ golden_path_integration模块导入成功')"
```

### 6. 魔搭平台环境变量准备

准备好以下环境变量的值:

**必需变量**:
- [ ] `MODEL_NAME` = `deepseek-chat`
- [ ] `OPENAI_API_KEY` = 你的DeepSeek API密钥
- [ ] `OPENAI_BASE_URL` = `https://api.deepseek.com/v1`

**可选变量** (使用默认值):
- [ ] `DETECTION_MODEL_NAME` = `deepseek-reasoner`
- [ ] `DETECTION_API_KEY` = 同上
- [ ] `DETECTION_BASE_URL` = 同上
- [ ] `ENABLE_GOLDEN_PATH` = `false`
- [ ] `ML_AUTO_TRAIN` = `true`

## 🔑 API密钥获取

### DeepSeek API
1. 访问: https://platform.deepseek.com/
2. 注册/登录账号
3. 进入"API Keys"页面
4. 创建新的API密钥
5. 复制密钥(格式: `sk-...`)

**注意**: 
- 确保账户有足够的余额
- API密钥创建后只显示一次,请妥善保存
- 不要将API密钥提交到Git仓库

## 📦 Git提交检查

提交前确认:
```bash
# 查看将要提交的文件
git status

# 确认没有包含敏感信息
git diff

# 确认.env文件被忽略
git check-ignore .env
# 应该输出: .env
```

## 🚀 部署流程

### 步骤1: 提交代码
```bash
git add .
git commit -m "准备部署到魔搭平台"
git push origin main
```

### 步骤2: 配置魔搭平台

1. 登录魔搭平台
2. 进入创空间设置
3. 添加环境变量(见上方清单)
4. 保存配置

### 步骤3: 触发部署

1. 点击"重新构建"
2. 等待构建完成(3-5分钟)
3. 查看构建日志

### 步骤4: 验证部署

1. 访问创空间URL
2. 检查应用状态
3. 测试游戏功能

## 🔍 部署后验证

### 应用启动验证
查看日志应该包含:
```
✓ 黄金路径学习系统已启用 (或兼容模式)
✓ 游戏结束时会自动收集数据
INFO:     Uvicorn running on http://0.0.0.0:7860
INFO:     Application startup complete.
```

### 功能验证
- [ ] 可以访问游戏界面
- [ ] 可以创建游戏
- [ ] AI玩家可以正常发言
- [ ] 投票功能正常
- [ ] 游戏可以正常结束

## ❌ 常见错误及解决

### 错误1: ModuleNotFoundError
```
ModuleNotFoundError: No module named 'werewolf'
```
**解决**: 检查 `werewolf/__init__.py` 是否存在

### 错误2: KeyError: 'MODEL_NAME'
```
KeyError: 'MODEL_NAME'
```
**解决**: 在魔搭平台添加 `MODEL_NAME` 环境变量

### 错误3: ImportError: golden_path_integration
```
ImportError: No module named 'golden_path_integration'
```
**解决**: 确认 `golden_path_integration.py` 已提交到仓库

### 错误4: API调用失败
```
openai.error.AuthenticationError
```
**解决**: 检查 `OPENAI_API_KEY` 是否正确

## 📊 资源监控

部署后监控:
- CPU使用率 (应该 < 80%)
- 内存使用率 (应该 < 80%)
- API调用次数
- 响应时间

## 🎯 性能优化建议

如果遇到性能问题:
1. 升级资源配置 (4核32GB)
2. 启用缓存机制
3. 优化API调用频率
4. 减少日志输出

## 📝 部署记录

记录每次部署的信息:
- 部署时间: ___________
- Git提交ID: ___________
- 环境变量版本: ___________
- 资源配置: ___________
- 部署结果: ___________
- 问题记录: ___________

## ✅ 最终确认

在点击"部署"之前,确认:
- [ ] 所有自动检查通过
- [ ] 所有手动检查完成
- [ ] API密钥已准备好
- [ ] 代码已提交到Git
- [ ] 环境变量已配置
- [ ] 已阅读故障排查文档

**准备好了吗? 开始部署! 🚀**

---

**提示**: 首次部署可能需要较长时间,请耐心等待。如果失败,查看日志并根据错误信息调整配置。
