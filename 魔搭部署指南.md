# 魔搭平台部署指南 - 狼人杀AI系统

## 📋 部署前检查清单

✅ 所有必需文件已就绪:
- ✓ `Dockerfile` - Docker镜像配置
- ✓ `start.sh` - 启动脚本
- ✓ `requirements-lite.txt` - 轻量级依赖
- ✓ `ms_deploy.json` - 魔搭部署配置
- ✓ `golden_path_integration.py` - 学习系统兼容模块
- ✓ `werewolf/__init__.py` - 主模块初始化

## 🚀 快速部署步骤

### 1. 准备API密钥

你需要准备以下API密钥:
- **DeepSeek API密钥**: 用于AI对话生成
- 获取地址: https://platform.deepseek.com/

### 2. 在魔搭平台配置环境变量

登录魔搭平台后,在你的创空间设置中添加以下环境变量:

| 变量名 | 值 | 说明 |
|--------|-----|------|
| `MODEL_NAME` | `deepseek-chat` | 主对话模型 |
| `OPENAI_API_KEY` | `sk-你的密钥` | DeepSeek API密钥 |
| `OPENAI_BASE_URL` | `https://api.deepseek.com/v1` | API地址 |
| `DETECTION_MODEL_NAME` | `deepseek-reasoner` | 分析模型(可选) |
| `DETECTION_API_KEY` | `sk-你的密钥` | 分析模型密钥(可选) |
| `DETECTION_BASE_URL` | `https://api.deepseek.com/v1` | 分析API地址(可选) |
| `ENABLE_GOLDEN_PATH` | `false` | 禁用高级学习(推荐) |
| `ML_AUTO_TRAIN` | `true` | 启用基础ML训练 |

**重要提示**: 
- 必须设置 `MODEL_NAME`, `OPENAI_API_KEY`, `OPENAI_BASE_URL`
- 其他变量有默认值,可以不设置
- `DETECTION_*` 变量可以使用相同的API密钥

### 3. 提交代码到Git仓库

```bash
# 添加所有文件
git add .

# 提交更改
git commit -m "准备部署到魔搭平台"

# 推送到远程仓库
git push origin main
```

### 4. 在魔搭平台部署

1. 登录 [魔搭平台](https://modelscope.cn/)
2. 进入你的创空间
3. 点击 "设置" → "环境变量"
4. 添加上述环境变量
5. 点击 "重新构建" 或 "重新部署"
6. 等待构建完成(约3-5分钟)

### 5. 验证部署

部署成功后:
1. 访问你的创空间URL: `https://你的空间名.modelscope.cn`
2. 应该看到狼人杀游戏界面
3. 可以开始游戏测试

## 🔍 故障排查

### 问题1: Internal Server Error

**可能原因**:
- 环境变量未设置或设置错误
- API密钥无效

**解决方法**:
1. 检查魔搭平台的环境变量设置
2. 确认API密钥有效(可以在本地测试)
3. 查看部署日志中的具体错误信息

### 问题2: 构建失败

**可能原因**:
- 依赖包安装失败
- 网络问题

**解决方法**:
1. 检查 `requirements-lite.txt` 是否正确
2. 查看构建日志中的错误信息
3. 尝试重新构建

### 问题3: 应用启动失败

**可能原因**:
- 缺少必需的环境变量
- 模块导入失败

**解决方法**:
1. 查看应用日志
2. 确认 `MODEL_NAME` 和 `OPENAI_API_KEY` 已设置
3. 检查 `werewolf` 模块是否完整

### 问题4: 游戏运行异常

**可能原因**:
- API调用失败
- 内存不足

**解决方法**:
1. 检查API密钥余额
2. 查看应用日志中的错误信息
3. 考虑升级资源配置

## 📊 资源配置说明

当前配置: `platform/2v-cpu-16g-mem`
- CPU: 2核
- 内存: 16GB
- 适合: 轻量级部署,支持基础ML功能

如需更多资源,可以修改 `ms_deploy.json` 中的 `resource_configuration`:
- `platform/4v-cpu-32g-mem` - 4核32GB(推荐用于生产环境)
- `platform/8v-cpu-64g-mem` - 8核64GB(高性能)

## 🔧 本地测试

在推送到魔搭之前,可以本地测试Docker镜像:

```bash
# 构建镜像
docker build -t werewolf-game .

# 运行容器
docker run -p 7860:7860 \
  -e MODEL_NAME=deepseek-chat \
  -e OPENAI_API_KEY=你的密钥 \
  -e OPENAI_BASE_URL=https://api.deepseek.com/v1 \
  werewolf-game

# 访问测试
curl http://localhost:7860
```

## 📝 环境变量详细说明

### 必需变量

| 变量 | 说明 | 示例 |
|------|------|------|
| `MODEL_NAME` | 主对话模型名称 | `deepseek-chat` |
| `OPENAI_API_KEY` | API密钥 | `sk-xxx...` |
| `OPENAI_BASE_URL` | API基础URL | `https://api.deepseek.com/v1` |

### 可选变量

| 变量 | 默认值 | 说明 |
|------|--------|------|
| `DETECTION_MODEL_NAME` | 同`MODEL_NAME` | 消息分析专用模型 |
| `DETECTION_API_KEY` | 同`OPENAI_API_KEY` | 分析模型API密钥 |
| `DETECTION_BASE_URL` | 同`OPENAI_BASE_URL` | 分析模型API地址 |
| `ENABLE_GOLDEN_PATH` | `false` | 是否启用高级学习系统 |
| `ML_AUTO_TRAIN` | `true` | 是否启用ML自动训练 |
| `ML_TRAIN_INTERVAL` | `10` | 训练间隔(游戏场数) |
| `ML_MIN_SAMPLES` | `50` | 最小训练样本数 |
| `LOG_LEVEL` | `INFO` | 日志级别 |

## 🎮 游戏功能说明

### 支持的角色
- 🐺 狼人 (Wolf)
- 👑 狼王 (Wolf King)
- 👨 村民 (Villager)
- 🔮 预言家 (Seer)
- 🧙 女巫 (Witch)
- 🛡️ 守卫 (Guard)
- 🏹 猎人 (Hunter)

### AI特性
- ✅ LLM驱动的智能对话
- ✅ 基于sklearn的异常检测
- ✅ 增量学习系统
- ✅ 自动数据收集
- ✅ 策略优化

### 轻量级版本限制
- ❌ 不包含深度学习(torch/transformers)
- ❌ 不包含XGBoost高级集成
- ❌ 不包含Golden Path三阶段学习

## 📞 获取帮助

如果遇到问题:
1. 查看本文档的故障排查部分
2. 检查魔搭平台的部署日志
3. 查看应用运行日志
4. 提交Issue到项目仓库

## 🔄 更新部署

当代码有更新时:
```bash
# 拉取最新代码
git pull

# 提交更改
git add .
git commit -m "更新代码"
git push

# 在魔搭平台点击"重新构建"
```

## ✅ 部署成功标志

部署成功后,你应该看到:
- ✓ 应用状态显示"运行中"
- ✓ 可以访问创空间URL
- ✓ 游戏界面正常显示
- ✓ 可以创建和开始游戏
- ✓ AI玩家可以正常发言和投票

## 🎉 开始游戏

部署成功后:
1. 访问你的创空间URL
2. 选择游戏模式和角色配置
3. 点击"开始游戏"
4. 享受AI狼人杀的乐趣!

---

**祝你部署顺利! 🚀**
