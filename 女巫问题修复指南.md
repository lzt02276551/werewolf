# å¥³å·«ï¼ˆ1å·ç©å®¶ï¼‰é—®é¢˜ä¿®å¤æŒ‡å—

## é—®é¢˜æ¦‚è¿°

æ ¹æ®æ—¥å¿—åˆ†æï¼Œå¥³å·«åœ¨ç¬¬1è½®å¤œæ™šæŠ€èƒ½é˜¶æ®µå‡ºç°ä¸¥é‡é”™è¯¯ï¼Œå¯¼è‡´æ¸¸æˆæ— æ³•ç»§ç»­ã€‚

---

## ğŸ”´ P0 - ä¸¥é‡é—®é¢˜ï¼ˆé˜»å¡æ¸¸æˆè¿›è¡Œï¼‰

### é—®é¢˜1: interactæ–¹æ³•è¿”å›Noneå¯¼è‡´ResponseValidationError

**é”™è¯¯ä¿¡æ¯:**
```
fastapi.exceptions.ResponseValidationError: 1 validation errors:
{'type': 'model_attributes_type', 'loc': ('response',), 'msg': 'Input should be a valid dictionary or object to extract fields from', 'input': None}
```

**å‘ç”Ÿæ—¶é—´:** 2026-02-21 16:01:48ï¼ˆç¬¬1è½®å¤œæ™šæŠ€èƒ½é˜¶æ®µï¼‰

**è§¦å‘æ¡ä»¶:**
- çŠ¶æ€: `status='skill'`
- æ¶ˆæ¯: `'Tonight, No.1 was killed'`ï¼ˆå¥³å·«è‡ªå·±è¢«æ€ï¼‰

**æ ¹æœ¬åŸå› :**

åœ¨ `werewolf/witch/witch_agent.py` ç¬¬279-298è¡Œçš„ `interact` æ–¹æ³•ä¸­ï¼š

```python
def interact(self, req: AgentReq) -> AgentResp:
    logger.info(f"[WITCH INTERACT] Status: {req.status}")

    if req.status == STATUS_SKILL:
        return self._handle_skill(req)
    elif req.status == STATUS_DISCUSS:
        return self._interact_discuss(req)
    elif req.status == STATUS_VOTE:
        return self._interact_vote(req)
    else:
        # å…¶ä»–çŠ¶æ€ä½¿ç”¨çˆ¶ç±»çš„é»˜è®¤å¤„ç†
        return super().interact(req)  # âŒ é—®é¢˜ï¼šçˆ¶ç±»BaseGoodAgentæ²¡æœ‰interactæ–¹æ³•
```

**é—®é¢˜åˆ†æ:**
1. å½“ `req.status` ä¸æ˜¯ `STATUS_SKILL`ã€`STATUS_DISCUSS` æˆ– `STATUS_VOTE` æ—¶ï¼Œä»£ç è°ƒç”¨ `super().interact(req)`
2. ä½†æ˜¯çˆ¶ç±» `BaseGoodAgent` æ²¡æœ‰å®ç° `interact` æ–¹æ³•
3. ç»§ç»­å‘ä¸ŠæŸ¥æ‰¾åˆ° `BaseAgent`ï¼Œå®ƒä¹Ÿæ²¡æœ‰ `interact` æ–¹æ³•
4. æœ€ç»ˆè¿”å› `None`ï¼Œå¯¼è‡´FastAPIå“åº”éªŒè¯å¤±è´¥

**ä¿®å¤æ–¹æ¡ˆ:**

```python
def interact(self, req: AgentReq) -> AgentResp:
    """
    å¤„ç†äº¤äº’è¯·æ±‚

    Args:
        req: äº¤äº’è¯·æ±‚

    Returns:
        AgentResp: äº¤äº’å“åº”
    """
    logger.info(f"[WITCH INTERACT] Status: {req.status}")

    if req.status == STATUS_SKILL:
        return self._handle_skill(req)
    elif req.status == STATUS_DISCUSS:
        return self._interact_discuss(req)
    elif req.status == STATUS_VOTE:
        return self._interact_vote(req)
    else:
        # æœªçŸ¥çŠ¶æ€ï¼Œè¿”å›é»˜è®¤å“åº”
        logger.warning(f"[WITCH INTERACT] Unknown status: {req.status}, returning default response")
        return AgentResp(success=True, result="", errMsg=None)
```

**å½±å“èŒƒå›´:** é˜»å¡æ¸¸æˆè¿›è¡Œï¼Œå¯¼è‡´å¥³å·«æ— æ³•å“åº”ä»»ä½•è¯·æ±‚

---

### é—®é¢˜2: perceiveæ–¹æ³•æ²¡æœ‰è¿”å›å€¼

**ä½ç½®:** `werewolf/witch/witch_agent.py` ç¬¬120-133è¡Œ

**å½“å‰ä»£ç :**
```python
def perceive(self, req: AgentReq):
    """
    å¤„ç†æ¸¸æˆäº‹ä»¶ï¼ˆé‡å†™çˆ¶ç±»æ–¹æ³•ä»¥æ·»åŠ å¥³å·«ç‰¹æœ‰å¤„ç†ï¼‰
    
    Args:
        req: æ¸¸æˆäº‹ä»¶è¯·æ±‚
    """
    # å¥³å·«ç‰¹æœ‰äº‹ä»¶ï¼šæŠ€èƒ½ä½¿ç”¨ï¼ˆè§£è¯/æ¯’è¯ï¼‰
    if req.status == STATUS_SKILL:
        return self._handle_skill(req)  # âœ“ æœ‰è¿”å›å€¼
    else:
        # å…¶ä»–äº‹ä»¶ä½¿ç”¨çˆ¶ç±»å¤„ç†
        super().perceive(req)  # âŒ æ²¡æœ‰è¿”å›çˆ¶ç±»çš„è¿”å›å€¼
```

**é—®é¢˜åˆ†æ:**
- å½“ `req.status != STATUS_SKILL` æ—¶ï¼Œè°ƒç”¨äº† `super().perceive(req)` ä½†æ²¡æœ‰è¿”å›å…¶ç»“æœ
- å¦‚æœçˆ¶ç±»çš„ `perceive` æ–¹æ³•æœ‰è¿”å›å€¼ï¼Œè¿™é‡Œä¼šä¸¢å¤±

**ä¿®å¤æ–¹æ¡ˆ:**

```python
def perceive(self, req: AgentReq):
    """
    å¤„ç†æ¸¸æˆäº‹ä»¶ï¼ˆé‡å†™çˆ¶ç±»æ–¹æ³•ä»¥æ·»åŠ å¥³å·«ç‰¹æœ‰å¤„ç†ï¼‰
    
    Args:
        req: æ¸¸æˆäº‹ä»¶è¯·æ±‚
    """
    # å¥³å·«ç‰¹æœ‰äº‹ä»¶ï¼šæŠ€èƒ½ä½¿ç”¨ï¼ˆè§£è¯/æ¯’è¯ï¼‰
    if req.status == STATUS_SKILL:
        return self._handle_skill(req)
    else:
        # å…¶ä»–äº‹ä»¶ä½¿ç”¨çˆ¶ç±»å¤„ç†
        return super().perceive(req)  # âœ“ è¿”å›çˆ¶ç±»çš„è¿”å›å€¼
```

**å½±å“èŒƒå›´:** å¯èƒ½å¯¼è‡´æŸäº›æ¸¸æˆäº‹ä»¶å¤„ç†å¤±è´¥

---

## âš ï¸ P1 - é«˜ä¼˜å…ˆçº§é—®é¢˜ï¼ˆå½±å“æ¸¸æˆä½“éªŒï¼‰

### é—®é¢˜3: å¥³å·«è‡ªå·±è¢«æ€æ—¶çš„å¤„ç†é€»è¾‘ç¼ºå¤±

**åœºæ™¯:** æ—¥å¿—æ˜¾ç¤º `'Tonight, No.1 was killed'`ï¼Œå³å¥³å·«è‡ªå·±åœ¨ç¬¬ä¸€å¤œè¢«æ€

**å½“å‰é€»è¾‘é—®é¢˜:**
1. `_extract_killed_player` æ–¹æ³•ä¼šæå–å‡º "No.1"ï¼ˆå¥³å·«è‡ªå·±ï¼‰
2. `_decide_antidote_action` ä¼šå°è¯•å†³å®šæ˜¯å¦æ•‘è‡ªå·±
3. ä½†æ²¡æœ‰ç‰¹æ®Šå¤„ç†"è‡ªæ•‘"çš„é€»è¾‘

**å»ºè®®ä¿®å¤:**

åœ¨ `_make_skill_decision` æ–¹æ³•ä¸­æ·»åŠ è‡ªæ•‘æ£€æµ‹ï¼š

```python
def _make_skill_decision(self, req: AgentReq) -> Tuple[str, str]:
    """
    æŠ€èƒ½å†³ç­–ï¼ˆè§£è¯/æ¯’è¯ï¼‰
    """
    try:
        # å¢åŠ å¤œæ™šè®¡æ•°
        self.memory_dao.increment_night()
        current_night = self.memory_dao.get_current_night()
        
        # ä»å†å²ä¸­æå–è¢«æ€ç©å®¶
        victim = self._extract_killed_player(req.history)
        
        # âœ“ æ–°å¢ï¼šæ£€æŸ¥æ˜¯å¦æ˜¯è‡ªå·±è¢«æ€
        my_name = self.memory_dao.get_my_name()
        if victim == my_name:
            logger.info(f"[SKILL] Night {current_night}: Witch was killed, checking self-save strategy")
            # æ ¹æ®é…ç½®å†³å®šæ˜¯å¦è‡ªæ•‘
            if self._should_self_save(current_night):
                if self.memory_dao.get_has_antidote():
                    self.memory_dao.set_has_antidote(False)
                    self.memory_dao.add_saved_player(victim)
                    logger.info(f"[SKILL] Night {current_night}: SELF-SAVE")
                    return "antidote", victim
        
        # è§£è¯å†³ç­–ï¼ˆæ•‘å…¶ä»–äººï¼‰
        antidote_action = self._decide_antidote_action(victim, current_night)
        if antidote_action:
            return antidote_action
        
        # æ¯’è¯å†³ç­–
        poison_action = self._decide_poison_action(req, current_night)
        if poison_action:
            return poison_action
        
        logger.info(f"[SKILL] Night {current_night}: No action")
        return "none", ""
        
    except Exception as e:
        logger.error(f"Error in skill decision: {e}")
        return "none", ""

def _should_self_save(self, current_night: int) -> bool:
    """
    å†³å®šæ˜¯å¦è‡ªæ•‘
    
    Args:
        current_night: å½“å‰å¤œæ™šæ•°
        
    Returns:
        æ˜¯å¦åº”è¯¥è‡ªæ•‘
    """
    # ç¬¬ä¸€å¤œé€šå¸¸è‡ªæ•‘
    if current_night == 1:
        return True
    
    # åæœŸæ ¹æ®å±€åŠ¿åˆ¤æ–­
    # å¯ä»¥æ·»åŠ æ›´å¤æ‚çš„é€»è¾‘
    return False
```

**å½±å“èŒƒå›´:** å¥³å·«ç¬¬ä¸€å¤œè¢«æ€æ—¶å¯èƒ½æ— æ³•æ­£ç¡®è‡ªæ•‘

---

### é—®é¢˜4: å†å²æ¶ˆæ¯è§£æå¯èƒ½å¤±è´¥

**ä½ç½®:** `_extract_killed_player` æ–¹æ³•ï¼ˆç¬¬254-270è¡Œï¼‰

**å½“å‰ä»£ç :**
```python
def _extract_killed_player(self, history: List[str]) -> Optional[str]:
    try:
        for msg in reversed(history[-10:]):
            if "was killed" in msg or "died" in msg or "è¢«æ€" in msg:
                match = re.search(r'No\.(\d+)', msg)
                if match:
                    return f"No.{match.group(1)}"
        return None
    except Exception as e:
        logger.error(f"Error extracting killed player: {e}")
        return None
```

**æ½œåœ¨é—®é¢˜:**
1. åªæ£€æŸ¥æœ€è¿‘10æ¡æ¶ˆæ¯ï¼Œå¯èƒ½é—æ¼ä¿¡æ¯
2. æ­£åˆ™è¡¨è¾¾å¼ `r'No\.(\d+)'` å¯èƒ½åŒ¹é…åˆ°é”™è¯¯çš„ç©å®¶ç¼–å·
3. æ²¡æœ‰å¤„ç† `req.message` ç›´æ¥ä¼ é€’çš„æƒ…å†µ

**å»ºè®®ä¿®å¤:**

```python
def _extract_killed_player(self, req: AgentReq) -> Optional[str]:
    """
    ä»è¯·æ±‚ä¸­æå–è¢«æ€ç©å®¶
    
    Args:
        req: è¯·æ±‚å¯¹è±¡
        
    Returns:
        è¢«æ€ç©å®¶åç§°ï¼Œæœªæ‰¾åˆ°è¿”å›None
    """
    try:
        # ä¼˜å…ˆä»messageä¸­æå–
        if req.message:
            msg = str(req.message)
            if "was killed" in msg or "died" in msg or "è¢«æ€" in msg:
                match = re.search(r'No\.(\d+)', msg)
                if match:
                    victim = f"No.{match.group(1)}"
                    logger.info(f"[EXTRACT] Found victim from message: {victim}")
                    return victim
        
        # ä»å†å²ä¸­æå–
        if req.history:
            for msg in reversed(req.history[-10:]):
                if "was killed" in msg or "died" in msg or "è¢«æ€" in msg:
                    match = re.search(r'No\.(\d+)', msg)
                    if match:
                        victim = f"No.{match.group(1)}"
                        logger.info(f"[EXTRACT] Found victim from history: {victim}")
                        return victim
        
        logger.warning("[EXTRACT] No victim found in message or history")
        return None
        
    except Exception as e:
        logger.error(f"Error extracting killed player: {e}")
        return None
```

å¹¶ä¿®æ”¹ `_make_skill_decision` çš„è°ƒç”¨ï¼š

```python
# ä»è¯·æ±‚ä¸­æå–è¢«æ€ç©å®¶
victim = self._extract_killed_player(req)  # ä¼ å…¥æ•´ä¸ªreqå¯¹è±¡
```

**å½±å“èŒƒå›´:** å¯èƒ½å¯¼è‡´å¥³å·«æ— æ³•è¯†åˆ«è¢«æ€ç©å®¶

---

## ğŸ“‹ P2 - ä¸­ä¼˜å…ˆçº§é—®é¢˜ï¼ˆä»£ç è´¨é‡ï¼‰

### é—®é¢˜5: ç¼ºå°‘å¼‚å¸¸å¤„ç†å’Œæ—¥å¿—

**ä½ç½®:** å¤šä¸ªæ–¹æ³•ç¼ºå°‘è¯¦ç»†çš„å¼‚å¸¸å¤„ç†

**å»ºè®®æ”¹è¿›:**
1. åœ¨ `_decide_antidote_action` å’Œ `_decide_poison_action` ä¸­æ·»åŠ  try-except
2. å¢åŠ æ›´è¯¦ç»†çš„æ—¥å¿—è¾“å‡ºï¼Œä¾¿äºè°ƒè¯•
3. æ·»åŠ å‚æ•°éªŒè¯

---

## ğŸ”§ ä¿®å¤ä¼˜å…ˆçº§

1. **ç«‹å³ä¿®å¤ï¼ˆP0ï¼‰:**
   - é—®é¢˜1: interactæ–¹æ³•è¿”å›None
   - é—®é¢˜2: perceiveæ–¹æ³•æ²¡æœ‰è¿”å›å€¼

2. **å°½å¿«ä¿®å¤ï¼ˆP1ï¼‰:**
   - é—®é¢˜3: å¥³å·«è‡ªæ•‘é€»è¾‘
   - é—®é¢˜4: å†å²æ¶ˆæ¯è§£æ

3. **åç»­ä¼˜åŒ–ï¼ˆP2ï¼‰:**
   - é—®é¢˜5: å¼‚å¸¸å¤„ç†å’Œæ—¥å¿—

---

## ğŸ“ æµ‹è¯•å»ºè®®

ä¿®å¤åéœ€è¦æµ‹è¯•ä»¥ä¸‹åœºæ™¯ï¼š

1. **å¥³å·«ç¬¬ä¸€å¤œè¢«æ€** - éªŒè¯è‡ªæ•‘é€»è¾‘
2. **å¥³å·«ç¬¬ä¸€å¤œä¸è¢«æ€** - éªŒè¯æ­£å¸¸æ•‘äºº/æ¯’äººé€»è¾‘
3. **å¥³å·«è¯å“ç”¨å®Œ** - éªŒè¯æ— è¯å“æ—¶çš„å¤„ç†
4. **å¼‚å¸¸çŠ¶æ€** - éªŒè¯æœªçŸ¥statusçš„å¤„ç†

---

## ğŸ“Š æ—¥å¿—åˆ†ææ‘˜è¦

- **é”™è¯¯å‘ç”Ÿæ—¶é—´:** 2026-02-21 16:01:48
- **é”™è¯¯æ¬¡æ•°:** è¿ç»­7æ¬¡ç›¸åŒé”™è¯¯
- **å½±å“:** æ¸¸æˆæ— æ³•ç»§ç»­ï¼Œå¥³å·«æ— æ³•å“åº”æŠ€èƒ½è¯·æ±‚
- **æ ¹æœ¬åŸå› :** interactæ–¹æ³•åœ¨æœªçŸ¥çŠ¶æ€ä¸‹è¿”å›None

---

## âœ… ä¿®å¤æ£€æŸ¥æ¸…å•

- [ ] ä¿®å¤ interact æ–¹æ³•çš„è¿”å›å€¼é—®é¢˜
- [ ] ä¿®å¤ perceive æ–¹æ³•çš„è¿”å›å€¼é—®é¢˜
- [ ] æ·»åŠ å¥³å·«è‡ªæ•‘é€»è¾‘
- [ ] æ”¹è¿›å†å²æ¶ˆæ¯è§£æ
- [ ] æ·»åŠ å•å…ƒæµ‹è¯•
- [ ] è¿›è¡Œé›†æˆæµ‹è¯•
- [ ] æ›´æ–°æ–‡æ¡£

---

**ç”Ÿæˆæ—¶é—´:** 2026-02-21  
**åˆ†æè€…:** AI Assistant  
**æ—¥å¿—æ–‡ä»¶:** 12_Player_Werewolf_Agent_Template-20260221-161336.log
