# 魔搭平台部署问题 - 完整解决方案

## 📋 问题总结

**现象：** 访问魔搭创空间显示 "Internal Server Error"

**真实原因：** 缺少 README.md 文件

## 🔍 问题诊断过程

### 1. 初步分析
- ✅ Docker镜像构建成功
- ✅ 镜像推送成功
- ❌ 运行时出现500错误

### 2. 查看构建日志
发现应用启动过程：
```
[14:11:05] 狼人杀AI系统启动中（轻量级版本）...
[14:11:11] ✓ VillagerAgent initialized
[14:11:11] ✓ WolfAgent initialized
[14:11:11] ✓ SeerAgent initialized
[14:11:11] ✓ WitchAgent initialized
[14:11:11] ✓ GuardAgent initialized
[14:11:11] ✓ HunterAgent initialized
[14:11:11] ✓ WolfKingAgent initialized
[14:11:11] INFO: Uvicorn running on http://0.0.0.0:7860
```

所有Agent都成功初始化，服务器正常启动！

### 3. 发现真实错误
```
[14:12:15] INFO: 172.18.0.162:0 - "GET / HTTP/1.1" 500 Internal Server Error
[14:12:15] ERROR: Exception in ASGI application
[14:12:15] Traceback (most recent call last):
[14:12:15]   File "/usr/local/lib/python3.10/site-packages/agent_build_sdk/server/server.py", line 28, in read_root
[14:12:15]     with open("README.md", "r", encoding="utf-8") as f:
[14:12:15] FileNotFoundError: [Errno 2] No such file or directory: 'README.md'
```

**根本原因：** `agent_build_sdk` 的根路径处理器尝试读取 README.md 文件来显示项目说明，但 Dockerfile 中没有复制这个文件。

## ✅ 解决方案

### 修改 Dockerfile

**之前：**
```dockerfile
COPY werewolf/ ./werewolf/
COPY config.py utils.py ./
COPY start.sh test_minimal.py ./
```

**之后：**
```dockerfile
COPY werewolf/ ./werewolf/
COPY config.py utils.py ./
COPY start.sh test_minimal.py ./
COPY README.md ./
```

## 🚀 部署步骤

### 1. 提交代码
```bash
git add Dockerfile
git commit -m "修复：添加README.md到Docker镜像"
git push
```

### 2. 重新部署
- 进入魔搭创空间
- 点击"重新构建"或"重新部署"
- 等待构建完成（约1-2分钟，因为大部分层已缓存）

### 3. 验证成功
访问你的创空间URL，应该看到：
- README.md 的内容（项目说明）
- 或者游戏界面
- 不再是 "Internal Server Error"

## 📊 技术细节

### agent_build_sdk 的行为
SDK 在根路径 `/` 提供了一个默认处理器：
```python
@app.get("/")
async def read_root():
    with open("README.md", "r", encoding="utf-8") as f:
        content = f.read()
    return {"message": content}
```

这个处理器会读取 README.md 并返回其内容，用于展示项目信息。

### 为什么本地没问题？
本地开发时，README.md 文件存在于项目根目录，所以没有遇到这个问题。但在 Docker 容器中，只有明确 COPY 的文件才会存在。

## 🎯 关键经验

1. **查看完整的运行日志** - 不要只看构建日志
2. **注意 SDK 的默认行为** - agent_build_sdk 会尝试读取 README.md
3. **Docker 容器是隔离的** - 必须明确复制所有需要的文件
4. **500错误要看堆栈跟踪** - 错误信息在日志的后面部分

## 📝 其他发现

### 环境变量配置
从日志看，环境变量已经正确配置：
```
MODEL_NAME: deepseek-chat (从环境变量读取)
ENABLE_GOLDEN_PATH: false
ML_AUTO_TRAIN: true
```

### 警告信息（可忽略）
```
⚠ ML modules not available: No module named 'ml_enhanced'
WARNING: Golden Path learning system not available
```
这些是预期的警告，因为使用的是轻量级版本（requirements-lite.txt），不包含这些高级功能。

### 单模型模式
```
ℹ️ 未配置DETECTION_MODEL_NAME，将使用主模型进行分析（单模型模式）
```
这是正常的，如果需要双模型架构，可以在环境变量中添加 DETECTION_MODEL_NAME。

## 🎉 总结

问题已完全解决！只需要在 Dockerfile 中添加一行 `COPY README.md ./`，然后重新部署即可。

应用本身运行完全正常，所有7个角色的Agent都成功初始化，服务器也正常启动。唯一的问题就是缺少 README.md 文件导致访问根路径时出错。
